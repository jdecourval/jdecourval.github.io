{"ArchLinux/laptop":{"title":"laptop","links":[],"tags":[],"content":"Xiaomi RedmiBook Pro 15 2023\nRecently, I lost access to my job laptop, which I used to use from time to time for my personal needs. Although, that was not a priority, being close to November, I though it would be a good time of the year to get a new one, and so begun my search.\nHaving used a recent MacBook Pro geared with an M2Pro chip, I was a bit spoiled, and was not ready to downgrade too much on some aspects. I settled on these specs:\n\nEfficient CPU\nHigh quality metal frame\nHigh resolution screen\nGreat on Linux\n\nThe first criteria really defined my search. I’m not ready to get a new MacBook, they are way too expensive for my needs and I dislike MacOS, so back to x86. Yes, there’s Asahi Linux, but I’m not comfortable relying on Apple’s willingness to let the project continue. Plus, Intel CPUs have really week GPUs. AMD recently started selling Zen4 laptop CPUs and those are terrific: www.phoronix.com/review/amd-ryzen7-7840u\nBeing located in Canada, my options were quite limited.\n\nLenovo ThinkPad T16 Gen 2\nLenovo ThinkPad P16s Gen 2\nLenovo ThinkPad P14s Gen 4\n\nDrawback: 16GB of soldered RAM, warranty\n706.20USD,621.46 USD after cashback, 844$ CAD, plus some taxes and brokerage fee.\nInstallation\nI used many Linux distributions over the year, but for a personal computer, I settled again on ArchLinux. ArchLinux is by no mean appropriate for everyone, but I love it since it enables me to customize my installation to the points that understand the role of everything installed. It’s even more important for a laptop where I want to control what runs in the background so that I get the best possible battery life.\nI’ve been using ArchLinux since at least 2011. At that point, Arch came with an installer, that I used for my very first installation, before it got dropped, until very recently, when archinstall became part of the installation image. I’m used to install Linux manually, but given it’s available, I decided to try the new installer.\n\nzram\n\nbtrfs\nThere are a couple of good options for the filesystem(s), but I chose btrfs for a couple of reasons. Subvolumes work in practice, like more conveninant partitions.\nPost-installation\nSSH\n\nkeys\nagent\n\ndotfiles and zsh\ncachy-os, reflector\nparu\nBackups\nUsability\nFont configuration\nGTK\nHyprland, waybar, wayland and user session\n\nqt6-wayland, qt5-wayland\n\nSome packages\n\nImage viewer\nPDF viewer\n\nBluetooth\nThe Linux laptop experience certainly improved in the last few years. I was impressed how easy this part was as compared to last time.\n\nInstall blueman\nEnable the service\n\nsudo systemctl enable --now bluetooth\n\n\nAdd to hyprland\n\nexec-once = blueman-applet\nexec-once = blueman-tray\n\n\nDisable auto power-on\nPlugins→PowerManager→Configuration\nSwitch Auto power-on to off\n\nBugs\nWi-Fi and bluetooth\nAltough the Linux kernel has a perfectly working driver for the laptop’s wifi chip, the chip’s PCI vendor ID is not recognized. It’s not too hard to word around this by patching and compiling the module, I’ve had to do that for cheap weird USB WiFi chips in the past, but thankfully here, it’s not necessary if you can upgrade to the not-yet-released kernel 6.7 which includes the fix.\nCustom kernel 6.7\npatchwork.kernel.org/project/linux-wireless/patch/20230824135232.5000-1-lundril@gmx.de/#25485296\nsuspend-then-hybernate\nhack-suspend-then-hibernate.service or rtc_cmos.use_acpi_alarm=1\nPSR\nBattery charge limit\nThe battery controler does not expose any way to limit the battery capacity or charge current. Neither does the BIOS. I don’t know whether this is a hardware limitation or a Linux driver issue.\nFingerprint reader\nThe fingerprint reader is not supported under Linux, and will probably never be.\n27c6:589a\ngitlab.freedesktop.org/libfprint/wiki/-/wikis/Unsupported-Devices/\nClock jump\nI’ve had the rtc jump to year 2077 after the laptop resumed from sleep. I did not bother looking into this given it’s pretty rare and can be easily worked around by doing:\ntimedatectl set-ntp false\ntimedatectl set-ntp true\n\nUnable to read current time from RTC\nor \nmach_set_cmos_time: RTC write failed with error -22\n\nProbably fixed by this:\nlore.kernel.org/all/20231128053653.101798-5-mario.limonciello@amd.com/T/#m55e9858cccb261c8a0fbf721599a768fc7a61ba8\nUnknown\n[81519.034311] ACPI BIOS Error (bug): AE_AML_BUFFER_LIMIT, Index (0x000000012) is beyond end of object (length 0x12) (20230628/exoparg2-393)\n[81519.034320] ACPI Error: Aborting method \\_SB.A032 due to previous error (AE_AML_BUFFER_LIMIT) (20230628/psparse-529)\n[81519.034323] ACPI Error: Aborting method \\_SB.ALIB due to previous error (AE_AML_BUFFER_LIMIT) (20230628/psparse-529)\n[81519.034325] ACPI Error: Aborting method \\_SB.PCI0.LPC0.EC0.SVRP due to previous error (AE_AML_BUFFER_LIMIT) (20230628/psparse-529)\n[81519.034327] ACPI Error: Aborting method \\_SB.PCI0.LPC0.EC0._Q93 due to previous error (AE_AML_BUFFER_LIMIT) (20230628/psparse-529)\n\nOptimization\nmakepkg\nI wanted to make this change quite soon given it will affect all further built packages.\nfstab (or rename filesystem?)\nbtrfs maintenances\ntlp\nDisable Webcam (temporary)\npowertop → kitty\nInterrupts coalescing\nCustom kernel\nkernel options\nio schedulers\nsysctls\n60Hz\nTDP tuning\nResults while compiling:\n45 Watts limit:\n❯ cat /sys/class/power_supply/BATT/power_now\n55737000\n# 20 Watts limit:\n❯ cat /sys/class/power_supply/BATT/power_now\n28143000\n\nwww.reddit.com/r/AMDLaptops/comments/178k7v5/7840hs_benchmarked_at_various_tdp/\nNeed kernel boot param.\nFirefox\nSpace saving\n\npaccache-hook\n\nsudo mkdir /etc/systemd/coredump.conf.d/\nsudo vim /etc/systemd/coredump.conf.d/custom.conf\n\n/etc/systemd/journald.conf.d/custom.conf\n[Journal]\nSystemMaxUse=100M\nMaxRetentionSec=1week\n\nwiki.archlinux.org/title/Core_dump#Using_systemd\n~/.config/user-tmpfiles.d/cache.conf\nsystemctl —user enable —now systemd-tmpfiles-clean.timer\nDNS\nMost of the web traffic nowadays is encrypted, but not DNS. Most network propose a DNS server via DHCP, but that may not be a fast one.\nLast step: defrag+balance\nsudo btrfs filesystem defragment -r -czstd /\nsudo btrfs filesystem defragment -r -czstd /home\nsudo /usr/bin/btrfs balance start -dusage=50 -dlimit=2 -musage=50 -mlimit=4 \n\nBIOS"},"index":{"title":"index","links":[],"tags":[],"content":"Hello world"}}